<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">

<head>
<script type="text/javascript" src="http://cdn.socket.io/stable/socket.io.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
<script type="text/javascript">
$(function() {
    var socket = new io.Socket(null, {port: 8080});
    socket.connect();
    //グローバル変数でflagを設定
    var flag = false;
    $("#target").draggable();
    $('#target').mousedown(function () {
        flag = true;
    });
    $('#target').mouseup(function () {
        flag = false;
    });

    $('#box').mousemove(function(event){
        // タッチした座標を取得
        var x = event.pageX - $('#box').position().left;
        var y = event.pageY - $('#box').position().top;
        if(flag){
          //緑色の四角の座標に指定
          $('#target').css('left',x);
        $('#target').css('top',y);
        var message = JSON.stringify({x:x, y:y,action:'mousemove'});
        //サーバに送る
        socket.send(message);
      }
    });

    $('#button').click(function() {
      var talk = $('#input').val();//inputの中のデーターを取得
      socket.send(JSON.stringify({word:talk,action:'chat'}));//server.jsへ送信
      return false;
    });


    // 受信ハンドラ（サーバからの受信時）
    socket.on('message', function(msg) {
        var obj =  JSON.parse(msg);
        var action = obj.action;
        switch(action){
        case 'mousemove':
          $("#first").text("X：" + obj.x);
          $("#second").text("Y：" + obj.y);
          $('#target').css('left',obj.x);
          $('#target').css('top',obj.y);
          break;
        case 'chat':
          $("#third").append(obj.word + '<br>');
          break;
        }
    });

});


</script>

</head>
<body>

<div id="box" style="width:540px; height:250px; background-color:blue">

<div id='target' style="width:40px; height:20px; background-color:#99cc00;"></div>

</div><!--box-->


<span id="first" style="display:block;">緑色の四角を移動させてください。</span>
<span id="second" style="display:block;"></span>

<form>
  <input type="text" id="input" ></input>
  <input type="submit" id="button" value="送信"></input>
</form>

<span id="third" style="display:block;"></span>

</body>
</html>
